import{t as z,r as o,G as h,j as e,a0 as G,a1 as K,d as _,z as N,D as C,B as y,L as j,a2 as q,a3 as H,a4 as J,a5 as Q,a6 as I,a7 as O}from"./index-BqRwj0yQ.js";import{l as V,c as W,d as X,s as Z}from"./localStorage-B8oYglUC.js";const ee=["buyer","seller"];function T(r){if(!r)return"N/A";if(typeof r=="string"){const a=Date.parse(r);return Number.isNaN(a)?r:new Date(a).toLocaleDateString()}return r instanceof Date?r.toLocaleDateString():typeof r.toDate=="function"?r.toDate().toLocaleDateString():"N/A"}function te(){const{user:r,profile:a,loading:S,updateRole:U}=z(),[t,p]=o.useState({name:"",email:"",role:"buyer"}),[v,w]=o.useState(!1),[B,x]=o.useState(null),[F,m]=o.useState([]),[k,n]=o.useState(null),[D,u]=o.useState([]),[E,d]=o.useState(null),[L,b]=o.useState(!1),R=o.useRef({}),A=o.useRef({});if(h&&S)return e.jsx("p",{className:"text-muted-foreground",children:"Loading your dashboard..."});o.useEffect(()=>{if(!h){const s=V();s&&p(s),w(!0);return}S||(p({name:(a==null?void 0:a.name)||(r==null?void 0:r.displayName)||"",email:(a==null?void 0:a.email)||(r==null?void 0:r.email)||"",role:(a==null?void 0:a.role)||"buyer"}),w(!0))},[a==null?void 0:a.email,a==null?void 0:a.name,a==null?void 0:a.role,S,r==null?void 0:r.displayName,r==null?void 0:r.email]);const f=o.useMemo(()=>{const s=W();return t.email?s.filter(i=>i.email===t.email):s},[t.email]),g=o.useMemo(()=>{const s=X();return t.email?s.filter(i=>i.contactEmail===t.email):s},[t.email]),P=async()=>{if(!h){if(!t.email){m(f),n("Add your email to sync bookings from Firestore.");return}try{const s=await q(t.email);m(s.length?s:f),n(s.length?"Synced from Firestore.":"Showing locally saved bookings.")}catch{m(f),n("Showing locally saved bookings. Firestore sync unavailable.")}return}if(!r){m(f),n("Sign in to sync bookings from Firestore.");return}try{const s=await H(r.uid);s.length||f.length===0?(m(s),n("Synced from Firestore.")):(m(f),n("Showing locally saved bookings."))}catch{m(f),n("Showing locally saved bookings. Firestore sync unavailable.")}},Y=async()=>{if(!h){if(!t.email){u(g),d("Add your email to sync submissions from Firestore.");return}try{const s=await J(t.email);u(s.length?s:g),d(s.length?"Synced from Firestore.":"Showing locally saved submissions.")}catch{u(g),d("Showing locally saved submissions. Firestore sync unavailable.")}return}if(!r){u(g),d("Sign in to sync submissions from Firestore.");return}try{const s=await Q(r.uid);s.length||g.length===0?(u(s),d("Synced from Firestore.")):(u(g),d("Showing locally saved submissions."))}catch{u(g),d("Showing locally saved submissions. Firestore sync unavailable.")}};o.useEffect(()=>{if(!v)return;if(!h||!r){t.role==="buyer"?P():Y();return}if(t.role==="buyer"){const i=G(r.uid,l=>{m(l),l.forEach(c=>{if(!c.id)return;const M=R.current[c.id];M&&M!==(c.status||"pending")&&O(`Booking status updated: ${c.status||"pending"}`),R.current[c.id]=c.status||"pending"}),n("Synced from Firestore.")},l=>n(l.message));return()=>i()}const s=K(r.uid,i=>{u(i),i.forEach(l=>{if(!l.id)return;const c=A.current[l.id];c&&c!==l.status&&O(`Submission status updated: ${l.status}`),A.current[l.id]=l.status}),d("Synced from Firestore.")},i=>d(i.message));return()=>s()},[v,t.email,t.role,r==null?void 0:r.uid]);const $=async()=>{if(x(null),!t.name||!t.email){x("Please add your name and email.");return}if(!h){Z(t),b(!0);try{await I(t),x("Profile saved and synced to Firestore.")}catch{x("Profile saved locally. Firestore sync failed.")}finally{b(!1)}return}if(!r){x("Sign in to save your profile.");return}b(!0);try{await I({name:t.name,email:t.email,role:t.role,uid:r.uid}),await U(t.role),x("Profile saved to Firestore.")}catch{x("Unable to save profile right now.")}finally{b(!1)}};return e.jsxs("section",{className:"py-16 px-4 sm:px-6 lg:px-8 bg-background",children:[e.jsx(_,{title:"Dashboard",description:"Manage your bookings, submissions, and traveler profile."}),e.jsxs("div",{className:"max-w-6xl mx-auto space-y-10",children:[e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("h1",{className:"text-3xl sm:text-4xl text-foreground",children:"Your Dashboard"}),e.jsx("p",{className:"text-muted-foreground max-w-2xl mx-auto",children:"Keep your profile updated and track bookings or tour submissions based on your role."})]}),e.jsxs("div",{className:"bg-card border border-border rounded-lg p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl text-foreground mb-1",children:"Profile"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Set your role to switch between buyer and seller tools."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(N,{htmlFor:"profileName",children:"Full Name"}),e.jsx(C,{id:"profileName",value:t.name,onChange:s=>p({...t,name:s.target.value}),placeholder:"Your name"})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"profileEmail",children:"Email"}),e.jsx(C,{id:"profileEmail",type:"email",value:t.email,onChange:s=>p({...t,email:s.target.value}),placeholder:"you@example.com",disabled:h&&!!r})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"profileRole",children:"Role"}),e.jsx("select",{id:"profileRole",value:t.role,onChange:s=>p({...t,role:s.target.value}),className:"h-10 w-full rounded-md border border-border bg-card px-3 text-sm",children:ee.map(s=>e.jsx("option",{value:s,children:s==="buyer"?"Buyer":"Seller"},s))})]})]}),B&&e.jsx("p",{className:"text-sm text-muted-foreground",children:B}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx(y,{onClick:$,disabled:L,className:"btn-micro bg-primary hover:bg-primary/90 text-primary-foreground",children:L?"Saving...":"Save Profile"}),e.jsx(y,{asChild:!0,variant:"outline",children:e.jsx(j,{to:"/tours",children:"Browse Tours"})})]})]}),t.role==="buyer"?e.jsxs("div",{className:"bg-card border border-border rounded-lg p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl text-foreground",children:"Your Bookings"}),k&&e.jsx("p",{className:"text-sm text-muted-foreground",children:k})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{asChild:!0,variant:"outline",children:e.jsx(j,{to:"/feedback",children:"Leave Feedback"})}),e.jsx(y,{asChild:!0,className:"btn-micro bg-primary hover:bg-primary/90 text-primary-foreground",children:e.jsx(j,{to:"/tours",children:"Book a Tour"})})]})]}),F.length===0?e.jsx("p",{className:"text-muted-foreground",children:"No bookings yet. Book a tour to see it here."}):e.jsx("div",{className:"space-y-3",children:F.map((s,i)=>e.jsxs("div",{className:"border border-border rounded-lg p-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-foreground font-medium",children:s.tourTitle}),e.jsx("span",{className:"text-xs uppercase tracking-wide text-muted-foreground",children:s.status||"pending"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Dates: ",s.startDate," to ",s.endDate]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Submitted: ",T(s.submittedAt||s.createdAt)]})]},s.id||i))})]}):e.jsxs("div",{className:"bg-card border border-border rounded-lg p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl text-foreground",children:"Your Tour Submissions"}),E&&e.jsx("p",{className:"text-sm text-muted-foreground",children:E})]}),e.jsx(y,{asChild:!0,className:"btn-micro bg-primary hover:bg-primary/90 text-primary-foreground",children:e.jsx(j,{to:"/create-tour",children:"Submit New Tour"})})]}),D.length===0?e.jsx("p",{className:"text-muted-foreground",children:"No submissions yet. Share your first tour idea."}):e.jsx("div",{className:"space-y-3",children:D.map((s,i)=>e.jsxs("div",{className:"border border-border rounded-lg p-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-foreground font-medium",children:s.title}),e.jsx("span",{className:"text-xs uppercase tracking-wide text-muted-foreground",children:s.status})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Season: ",s.season," - ",s.price]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Submitted: ",T(s.submittedAt||s.createdAt)]})]},s.id||i))})]})]})]})}export{te as UserDashboardPage};
